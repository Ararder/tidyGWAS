---
title: "tidyGWAS"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tidyGWAS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyGWAS)
```

# Installation

TO BE ADDED

```{r, eval=FALSE}

devtools::install_github("ararder/tidyGWAS")
# or
remotes::install_github("ararder/tidyGWAS")


# if you want to be able to repair CHR:POS or RSID, you need to download the following
# bioconductor packages:
if (!require("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install(version = "3.16")
BiocManager::install("BSgenome")
BiocManager::install("Biostrings")
BiocManager::install("BSgenome.Hsapiens.1000genomes.hs37d5")
BiocManager::install("BSgenome.Hsapiens.NCBI.GRCh38")
BiocManager::install("SNPlocs.Hsapiens.dbSNP155.GRCh37")
BiocManager::install("SNPlocs.Hsapiens.dbSNP155.GRCh38")


```

# Getting started

Automatic parsing of column names has not been implemented (and probable never will), so you will have to rename the input dataframe to the tidyGWAS format. The following column names are accepted:

```{r}

snp_cols <- c("CHR", "POS", "RSID", "EffectAllele", "OtherAllele", "rowid")
info_cols <- c("INFO", "N", "CaseN", "ControlN", "EAF")
stats_cols <- c("B", "Z", "OR", "P", "SE")
```

tidyGWAS relies on the [BSgenome](https://bioconductor.org/packages/release/bioc/html/BSgenome.html) package to look up CHR:POS or RSID in dbSNP. The merge with dbSNP (\~930 million rows) is the main consumer of memory and time. If you want to run tidyGWAS on several sumstats after each other, it is best to "load" the `BSgenome` data before running tidyGWAS. This will make all tidyGWAS calls after the first much faster.

```{r,eval = FALSE}
bsgenome <- get_bsgenome()

```

The input tibble should look like this:

```{r}
test_file <- tidyGWAS::test_file
test_file |>
  dplyr::tibble()
```

You can skip the step to align with dbSNP, which will significantly speed up running time and reduce memory usage, by not providing `bsgnome_objects`. To update the RSID colum, you also need to provide an RsMergeArch file. tidyGWAS will attempt to read in this file using a filepath provided in the R enviroment "rs_merge_arch".

```{r, eval=FALSE}
# You can download the rs_merge_arch file here:
file <- googledrive::as_dribble("https://drive.google.com/file/d/1HaES_q8m6rSDDLXvYr0TjQ-ZlyhdZbFX/view?usp=share_link")
googledrive::drive_download(file)
# use usethis to set the env variable rs_merge_arch to the filepath to the downloaded file 
# usethis::edit_r_environ()

```

```{r}
# use the small example file stored with tidyGWAS package
rs_merge_arch <- tidyGWAS::rs_merge_arch

```

```{r, collapse=TRUE}
start <- Sys.time()
tmp <- tidyGWAS(test_file, rs_merge_arch = rs_merge_arch)
end <- Sys.time()
```

About 3 seconds for 100k rows
```{r, collapse=TRUE}
end - start


```

If you want the information to be stored in a logfile on disk, you can use the logfile flag. Note that by default, tidyGWAS uses a folder in `tempdir` to store all intermediate files. These files are not saved indefinitely, so to store the output data, you can also provide an output directory where you want the copy over the finished tidyGWAS oflder

```{r, echo = FALSE}
my_outdir <- withr::local_tempdir("all_my_gwas_files")
tidyGWAS(test_file, rs_merge_arch = rs_merge_arch, logfile = TRUE, outdir = my_outdir)

```

If you dont provide a name for the sumstat cleaning, tidyGWAS uses `Sys.time()` to create a random name.

```{r}
list.files(my_outdir, recursive = TRUE)

```

This can be controlled with the `name` argument:

```{r, echo = FALSE}
tidyGWAS(test_file, rs_merge_arch = rs_merge_arch, logfile = TRUE, outdir = my_outdir, name = "first_gwas")
list.files(my_outdir, recursive = TRUE)

```

Oops! We now have two different folders in our outdir. This is a feature. `outdir` is meant to be used when you have many different sumstats that you all want to be in the same directory, with the same folder structure.
